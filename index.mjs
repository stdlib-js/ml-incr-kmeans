// Copyright (c) 2022 The Stdlib Authors. License is Apache-2.0: http://www.apache.org/licenses/LICENSE-2.0
/// <reference types="./index.d.ts" />
import{isPrimitive as e}from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-positive-integer@esm/index.mjs";import t from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-matrix-like@esm/index.mjs";import r from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-vector-like@esm/index.mjs";import s from"https://cdn.jsdelivr.net/gh/stdlib-js/utils-define-nonenumerable-read-only-property@esm/index.mjs";import i from"https://cdn.jsdelivr.net/gh/stdlib-js/error-tools-fmtprodmsg@v0.0.2-esm/index.mjs";import n from"https://cdn.jsdelivr.net/gh/stdlib-js/random-base-minstd-shuffle@esm/index.mjs";import o from"https://cdn.jsdelivr.net/gh/stdlib-js/math-base-special-floor@esm/index.mjs";import a from"https://cdn.jsdelivr.net/gh/stdlib-js/math-base-special-ln@esm/index.mjs";import d,{ndarray as m}from"https://cdn.jsdelivr.net/gh/stdlib-js/blas-base-dcopy@v0.0.10-esm/index.mjs";import f from"https://cdn.jsdelivr.net/gh/stdlib-js/array-float64@esm/index.mjs";import p from"https://cdn.jsdelivr.net/gh/stdlib-js/ndarray-ctor@esm/index.mjs";import l from"https://cdn.jsdelivr.net/gh/stdlib-js/ndarray-base-ctor@esm/index.mjs";import{ndarray as c}from"https://cdn.jsdelivr.net/gh/stdlib-js/blas-base-gcopy@v0.0.8-esm/index.mjs";import u from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-plain-object@esm/index.mjs";import h from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-has-own-property@esm/index.mjs";import{isPrimitive as j}from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-boolean@esm/index.mjs";import v from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-array-like-object@esm/index.mjs";import g from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-contains@esm/index.mjs";import y from"https://cdn.jsdelivr.net/gh/stdlib-js/math-base-special-sqrt@esm/index.mjs";import{factory as b}from"https://cdn.jsdelivr.net/gh/stdlib-js/random-sample@esm/index.mjs";import{factory as w}from"https://cdn.jsdelivr.net/gh/stdlib-js/random-base-discrete-uniform@esm/index.mjs";import{factory as x}from"https://cdn.jsdelivr.net/gh/stdlib-js/random-base-mt19937@esm/index.mjs";import E from"https://cdn.jsdelivr.net/gh/stdlib-js/constants-float64-pinf@v0.0.8-esm/index.mjs";import T from"https://cdn.jsdelivr.net/gh/stdlib-js/stats-incr-mean@esm/index.mjs";import z from"https://cdn.jsdelivr.net/gh/stdlib-js/stats-incr-meanstdev@esm/index.mjs";function R(e,t,r){return(r?l:p)("float64",new f(e*t),[e,t],[t,1],0,"row-major")}function L(e,t){var r,s,i,n,o,a,d,m,f,p,l;for(f=t.shape[0],p=t.shape[1],r=t.data,s=e.data,i=t.strides[0],n=t.strides[1],o=e.strides[0],a=e.strides[1],d=t.offset,m=e.offset,l=0;l<f;l++)c(p,r,n,d,s,a,m),d+=i,m+=o;return e}function k(e,t){return(t?l:p)("float64",new f(e),[e],[1],0,"row-major")}function A(e,t){return c(t.shape[0],t.data,t.strides[0],t.offset,e.data,e.strides[0],e.offset),e}var O=["euclidean","correlation","cosine"],M=["forgy","sample","kmeans++"];function V(t,r){if(!u(r))return new TypeError(i("0LR2h",r));if(h(r,"metric")&&(t.metric=r.metric,!g(O,t.metric)))return new TypeError(i("0LR3t","metric",O.join('", "'),t.metric));if(h(r,"init")){if(!v(r.init))return new TypeError(i("0LR4y","init",r.init));if(!g(M,r.init[0]))return new TypeError(i("0LR5B","init",M.join('", "'),r.init[0]));if(t.init[0]=r.init[0],r.init.length>1&&(t.init[1]=r.init[1],!e(t.init[1])))return new TypeError(i("invalid option. First `%s` parameter option must be a positive integer. Option: `%s`.","init",t.init[1]));if(r.init.length>2&&(t.init[2]=r.init[2],!e(t.init[2])))return new TypeError(i("invalid option. Second `%s` parameter option must be a positive integer. Option: `%s`.","init",t.init[2]))}return h(r,"normalize")&&(t.normalize=r.normalize,!j(t.normalize))?new TypeError(i("0LR30","normalize",t.normalize)):h(r,"copy")&&(t.copy=r.copy,!j(t.copy))?new TypeError(i("0LR30","copy",t.copy)):(h(r,"seed")&&(t.seed=r.seed),null)}var q={forgy:["forgy",1],sample:["sample",1],"kmeans++":["kmeans++",1,1]};function B(e,t,r,s){var i,n,o,a;for(n=0,i=s,a=0;a<e;a++)n+=(o=t[i])*o,i+=r;for(n=y(n),i=s,a=0;a<e;a++)t[i]/=n;return t}function F(e){var t,r,s,i,n,o,a;for(t=e.data,n=e.shape[0],o=e.shape[1],r=e.strides[0],s=e.strides[1],i=e.offset,a=0;a<n;a++)B(o,t,s,i),i+=r;return e}function N(e,t,r,s,i,n,o,a,d,m){var f,p,l,c;for(f=s,p=o,l=m,c=0;c<e;c++)t[f]=(t[f]-i[p])/a[l],f+=r,p+=n,l+=d;return t}function P(e,t){var r,s,i,n,o,a,d;for(r=e.data,o=e.shape[0],a=e.shape[1],s=e.strides[0],i=e.strides[1],n=e.offset,d=0;d<o;d++)N(a,r,i,n,t,2,0,t,2,1),n+=s;return e}function S(e,t,r,s,i,n,o){var a=function(e,t,r,s,i,n,o){var a,d,m,f,p;for(a=s,d=o,f=0,p=0;p<e;p++)f+=(m=t[a]-i[d])*m,a+=r,d+=n;return y(f)}(e,t,r,s,i,n,o);return a*a}function _(e,t,r,s,i,n,o){var a,d,m,f;for(a=s,d=o,m=0,f=0;f<e;f++)m+=t[a]*i[d],a+=r,d+=n;return m}function Y(e,t,r,s,i,n,o){var a=1-_(e,t,r,s,i,n,o);return a*a}function C(e,t,r,s,i,n,o){var a=1-_(e,t,r,s,i,n,o);return a*a}function D(e,t,r,s,i,n){var o,a,d,m,f;for(m=i.data,o=(d=i.strides[0])*n,a=0,f=0;f<r;f++)e[f]=t(s,m,1,a,m,1,o),a+=d;return e}function G(e,t,r,s,i,n,o,a,d){var m,f,p,l;for(m=E,l=0;l<t;l++)(p=e(r,s,1,n,o,a,d))<m&&(m=p,f=l),n+=i;return f}function H(e,t,r,s,i,n,o,a){var d,m;for(m=0;m<e;m++)d=r[i],d+=(n[a]-d)/t,r[i]=d,i+=s,a+=o;return r}function I(e,t,r,s,i,n){var o,a;return a=e.shape[1],function(d){void 0===o&&((o=R(n.init[1],a,!0)).count=0);if(o.count<n.init[1]&&(c(a,d.data,d.strides[0],d.offset,o.data,o.strides[1],o.strides[0]*o.count),o.count+=1,o.count<n.init[1]))return!1;n.normalize&&("cosine"===n.metric?o=F(o):"correlation"===n.metric&&(o=P(o,s())));e="forgy"===n.init[0]?function(e,t,r){var s,i,n,o,a,d,m,f,p,l,c,u,h,j,v,g;for(h=e.shape[0],j=e.shape[1],i=e.data,m=e.strides[0],f=e.strides[1],l=e.offset,o=t.data,n=t.shape[0],a=t.strides[0],d=t.strides[1],u=t.offset,s=w(0,h-1,{seed:r}),p=[],v=0;v<h*j;v++)p.push(T());for(v=0;v<n;v++){for(c=j*s(),g=0;g<j;g++)p[c+g](o[u+d*g]);u+=a}for(c=0,v=0;v<h;v++){for(g=0;g<j;g++)i[l+f*g]=p[c](),c+=1;l+=m}return e}(e,o,n.seed):"sample"===n.init[0]?function(e,t,r){var s,i,n,o,a,d,f,p,l,c,u;for(l=e.shape[0],c=e.shape[1],i=e.data,d=e.strides[1],f=e.offset,n=t.data,o=t.strides[0],a=t.strides[1],s=[],u=0;u<t.shape[0];u++)s.push(u);for(p=l===s.length?s:b({seed:r,size:l,mutate:!1,replacement:!1})(s),u=0;u<l;u++)m(c,n,a,o*p[u],i,d,f);return e}(e,o,n.seed):function(e,t,r,s,i){var n,o,a,d,f,p,l,c,u,h,j,v,g,y,b,T,z,R,L,k,A,O,M,V,q,B,F,N;if(V=e.shape[0],d=e.shape[1],c=t.shape[0],v=e.data,z=e.strides[0],R=e.strides[1],L=e.offset,g=t.data,b=t.strides[0],T=t.strides[1],l=x({seed:i}),a=w({seed:l()}),l=l.normalized,j="cosine"===r?Y:"correlation"===r?C:S,M=a(0,c-1),1===V)return m(d,g,T,b*M,v,R,L);for(n=[M],k=new Array(d),f=new Array(2*c),y=0,B=0;B<c;B++)f[y]=E,f[y+1]=0,y+=2;for(p=new Array(c),F=1;F<V;F++){for(D(k,j,c,d,t,n[F-1]),u=0,y=0,B=0;B<c;B++)k[B]<f[y]?(f[y]=k[B],f[y+1]=F-1,u+=k[B]):u+=f[y],y+=2;for(p[0]=f[0]/u,y=2,B=1;B<c;B++)p[B]=p[B-1]+f[y]/u,y+=2;for(h=E,A=-1,N=0;N<s;N++){for(M=-1;-1===M;)for(q=l(),B=0;B<c;B++)if(q<p[B]){M=B;break}for(u=0,o=b*M,y=0,B=0;B<c;B++)(O=j(d,g,1,b*B,g,1,o))<f[y]?u+=O:u+=f[y],y+=2;u<h&&(h=u,A=M)}n.push(A)}for(B=0;B<V;B++)m(d,g,T,b*n[B],v,R,L),L+=z;return e}(e,o,n.metric,n.init[2],n.seed);return function(e,t,r,s,i){var n,o,a,d,m,f,p,l,c,u,h;for(c=t.shape[0],n=t.shape[1],d=e.shape[0],o=t.data,m=t.strides[0],a=e.data,f=e.strides[0],l=0,h=0;h<d;h++)p=m*(u=G(i,c,n,o,m,0,a,1,l)),H(n,r.get(u,0)+1,o,1,p,a,1,l),s(u,i(n,o,1,p,a,1,l)),l+=f}(o,e,t,r,i),!0}}function J(e,t){var r,s;for(r=[],s=0;s<t;s++)r.push(0);return function(t,s){var i,n,o;return o=e.get(t,0)+1,e.set(t,0,o),e.set(t,1,e.get(t,1)+s),n=e.get(t,2),n+=(i=s-n)/o,r[t]+=i*(s-n),e.set(t,2,n),e.set(t,3,y(r[t]/(o-1))),e}}function K(e){var t,r,s,i,n;for(2,t=2*(s=new f(2*e)).BYTES_PER_ELEMENT,r=[],i=0,n=0;n<e;n++)r.push(z(new f(s.buffer,i,2))),i+=t;return function(t){var i;if(0===arguments.length)return s;for(i=0;i<e;i++)r[i](t.get(i));return s}}function Q(e,t){var r={};return r.centroids=R(e,t,!1),r.stats=R(e,4,!1),r}function U(){var m,f,p,l,c,u,h,j,v,g,y,b,w,x;if(t(arguments[0]))x=arguments[0].shape[0],j=arguments[0].shape[1],f=L(f=R(x,j,!0),arguments[0]),arguments.length>1&&(l=arguments[1],w=!0);else{if(!e(arguments[0]))throw new TypeError(i("0LR53",arguments[0]));if(x=arguments[0],!e(j=arguments[1]))throw new TypeError(i("0LR52",j));arguments.length>2&&(l=arguments[2],w=!0)}if((g={metric:"euclidean",init:q["kmeans++"].slice(),seed:n(),normalize:!0,copy:!0}).init[1]=x,g.init[2]=2+o(a(x)),w&&(b=V(g,l)))throw b;if(g.init[1]<x)throw new RangeError(i("invalid option. First `%s` parameter option must be greater than or equal to the number of clusters. Options: `%f`.","init",g.init[1]));return c=Q(x,j),h=R(x,4,!0),m=J(h,x),"cosine"===g.metric?(v=Y,g.copy&&(u=k(j,!0))):"correlation"===g.metric?(v=C,g.normalize&&(p=K(j)),g.copy&&(u=k(j,!0))):v=S,void 0===f?(f=R(x,j,!0),y=I(f,h,m,p,v,g)):L(c.centroids,f),s(E,"seed",g.seed),s(E,"predict",T),E;function E(e){var t,s,n,o,a,l,b,w,E,T,z;if(0===arguments.length)return y?null:c;if(!r(w=e))throw new TypeError(i("invalid argument. Must provide a one-dimensional ndarray. Value: `%s`.",w));if(w.shape[0]!==j)throw new Error(i("0LR56",j,w.shape[0]));if(p&&p(w),y){if(!1===y(w))return null;y=void 0}else g.normalize&&("cosine"===g.metric?(g.copy&&(w=A(u,w)),B(j,w.data,w.strides[0],w.offset)):"correlation"===g.metric&&(g.copy&&(w=A(u,w)),n=p(),N(j,w.data,w.strides[0],w.offset,n,2,0,n,2,1))),t=f.data,a=f.strides[0],s=w.data,o=w.strides[0],l=w.offset,b=a*(z=G(v,x,j,t,a,0,s,o,l)),E=h.get(z,0)+1,H(j,E,t,1,b,s,o,l),T=v(j,t,1,b,s,o,l),m(z,T);return d(f.length,f.data,1,c.centroids.data,1),d(h.length,h.data,1,c.stats.data,1),c}function T(e,s){var n,o,a,d,m,l,c,u,h,b,w;if(arguments.length>1){if(!r(e))throw new TypeError(i("invalid argument. Output argument must be a one-dimensional ndarray. Value: `%s`.",e));h=e,u=s}else u=e;if(!t(u))throw new TypeError(i("invalid argument. Must provide a two-dimensional ndarray. Value: `%s`.",u));if(u.shape[1]!==j)throw new Error(i("invalid argument. Number of matrix columns must match centroid dimensions. Expected: `%u`. Actual: `%u`.",j,u.shape[1]));if(void 0===h)h=k(u.shape[0],!1);else if(h.length!==u.shape[0])throw new Error(i("0LR5A",u.shape[0],h.length));if(y)return null;for(a=u.shape[0],g.normalize&&("cosine"===g.metric?(g.copy&&(u=L(R(a,j,!0),u)),u=F(u)):"correlation"===g.metric&&(g.copy&&(u=L(R(a,j,!0),u)),u=P(u,p()))),o=f.data,l=f.strides[0],n=u.data,d=u.strides[0],m=u.strides[1],c=u.offset,w=0;w<a;w++)b=G(v,x,j,o,l,0,n,m,c),h.set(w,b),c+=d;return h}}export{U as default};
//# sourceMappingURL=index.mjs.map
